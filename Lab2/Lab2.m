clc;
clear all;
close all;

% –ù–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
T0 = 0; % –ù–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
T = 20; % –ö–æ–Ω–µ—á–Ω–æ–µ –≤—Ä–µ–º—è
N = 10000; % –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º—É–ª—è—Ü–∏–π
m = 50; % –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç—Ä–µ–∑–∫–∞
dt = T / m; % –®–∞–≥ —Ä–∞–∑–±–∏–µ–Ω–∏—è

% f2 = (2.5)
f1 = 1;
prob = 0.005;
lambda_m = -log(prob) * f1;
disp(['lambda_m = ', num2str(lambda_m)]);

param_1 = f1^2;
param_2 = 1 / 2;
sigma = (f1^2 / 4)^(1/4);
alpha = (1 / 2) * param_2;

% –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ –ö–æ–∫—Å–∞ (—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π)

flow = cell(N, 1); % –ü–æ—Ç–æ–∫

for i = 1:N

    t = []; % –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ü. –ø–æ—Ç–æ–∫–∞ –ü—É–∞—Å—Å–æ–Ω–∞

    t_next = T0 - log(rand) / lambda_m;
    while(t_next >= T0 && t_next <= T) 
        t = [t t_next];
        t_prev = t_next;
        t_next = t_prev-log(rand)/lambda_m;
    end

    % –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã 
    x1 = zeros(1,length(t)); % —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    x2 = zeros(1,length(t));

    fi1 = randn(1, length(t)); % –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å–ª—É—á–∞–π–Ω–æ–π –≤–µ–ª–∏—á–∏–Ω—ã 
    fi2 = randn(1, length(t));
    x1(1) = sigma * fi1(1); % (2.6) —Ñ–∏ - –Ω–æ—Ä–º. —Ä–∞—Å–ø—Ä–µ–¥. [0, 1]
    x2(1) = sigma * fi2(1);

    % (2.6)
    for k = 2:length(t)
        x1(k) = x1(k-1)*exp(-alpha*(t(k)-t(k-1))) + sigma*fi1(k)*sqrt(1-exp(-2*alpha*(t(k)-t(k-1))));
        x2(k) = x2(k-1)*exp(-alpha*(t(k)-t(k-1))) + sigma*fi2(k)*sqrt(1-exp(-2*alpha*(t(k)-t(k-1))));
    end
    
    % (2.4) 
    xi = x1.^2 + x2.^2;

    % –ü—Ä–æ—Ä–µ–∂–∏–≤–∞–Ω–∏–µ
    % –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ xi –º–æ–¥–µ–ª–∏—Ä—É–µ–º 
    % —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–ª—É—á–∞–π–Ω–æ–π –≤–µ–ª–∏—á–∏–Ω—ã, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
    % [0; lambda_m].
    y = lambda_m * rand([1, length(t)]); 
    t_fin = t(y < xi);
    
    %disp('t_fin')
    %disp(t_fin);

    flow{i} = t_fin;
end

% –û—Ü–µ–Ω–∫–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ 

X = T0 + dt/2 : dt : T-dt/2; % —Ü–µ–Ω—Ç—Ä—ã –∫–∞—Ä–º–∞–Ω–æ–≤

hist_vect = zeros(1, m);

for i = 1:N
    hist_temp = hist(flow{i}, X);
    hist_vect = hist_vect + hist_temp;
end

% –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π
empirical = hist_vect / (N * dt);
teoretical = f1;

figure();
hold on;
plot(X, empirical, 'r', 'DisplayName', '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å')
plot(X, teoretical * ones(1, length(X)), 'b', 'DisplayName', '–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å')
title("–û—Ü–µ–Ω–∫–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ ");
xlabel("T");
ylabel("–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å");
legend()
hold off;

% –û—Ü–µ–Ω–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

% –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç—Ä–∏—Ü—ã –¥–ª—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–ö–æ–ª-–≤–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π –ø–æ—Ç–æ–∫–∞ N (—Å—Ç—Ä–æ–∫–∏) —Ö
% –∫–æ–ª-–≤–æ –∫–∞—Ä–º–∞–Ω–æ–≤ (—Å—Ç–æ–ª–±—Ü—ã)). –≠—Ç–∞ –º–∞—Ç—Ä–∏—Ü–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è 
% —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∫–∞–∂–¥–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞.
K = zeros(1, m);

% (1.8) - –¥–ª—è —Å—Ç–∞—Ü. –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
for L = 1:length(flow)
    k = hist(flow{L}, X);
    for i = 1:m
        summ = 0;
        if i == 1
            for j = 1:m
                summ = summ + (k(j) * (k(j) - 1))/(dt^2);
            end
            K(i) = K(i) + summ/m;
        else
            for j = 1:m - (i-1)
                summ = summ + (k(j)*k(j+i-1))/(dt^2);
            end
            K(i) = K(i) + summ/(m - (i-1));
        end
    end
end

K = K / length(flow);
K_theor = param_1 * (1 + exp(-X * param_2)); % –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ (2.1)
% –ú–æ–º–µ–Ω—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ –ö–æ–∫—Å–∞ —Ç–æ–∂–¥–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –º–æ–º–µ–Ω—Ç–Ω—ã–º–∏ 
% —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ ùúâ(ùë°). 

figure();
hold on;
plot(X, K, 'r', 'DisplayName', '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è');
plot(X, K_theor, 'b', 'DisplayName', '–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è');
title('–ì—Ä–∞—Ñ–∏–∫ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏');
legend();
hold off;
title("–û—Ü–µ–Ω–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏");

% –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π
% –í–µ—Ä-—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ –±—É–¥–µ—Ç n —Å–æ–±—ã—Ç–∏–π.

tc = 2;
A_p = tc / 10; % –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–±—ã—Ç–∏–π.

A_temp = cell(N, 1); % —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–∂–¥–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏

for n = 1:length(A_temp) 
    % –í—ã–±–∏—Ä–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ –¥–æ A_p.
    A_temp{n} = flow{n}(flow{n} < A_p);
end

% –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å–æ–±—ã—Ç–∏–π
max_events = length(A_temp{1});
for i = 2:length(A_temp)
    % –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –≤ –ª—é–±–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –≤—Ä–µ–º–µ–Ω–∏ 
    % —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å–∏–º—É–ª—è—Ü–∏–π.
    if length(A_temp{i}) > max_events
        max_events = length(A_temp{i});
    end
end

% –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
P = zeros(1, max_events + 1);
% –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç 0 –¥–æ max_num:
for i = 0:max_events
    % –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º—É–ª—è—Ü–∏–π —Å —Ç–∞–∫–∏–º —á–∏—Å–ª–æ–º —Å–æ–±—ã—Ç–∏–π,
    % –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ —ç—Ç–æ–≥–æ —á–∏—Å–ª–∞ —Å–æ–±—ã—Ç–∏–π.
    for n = 1:length(A_temp)
        if length(A_temp{n}) == i
            P(i+1) = P(i+1) + 1;
        end
    end
    P(i+1) = P(i+1) / length(A_temp);
end

% –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
P_theor = zeros(1, max_events+1);
m = f1 * A_p;
for k = 0:max_events
    P_theor(k+1) = m^k / ((m + 1) ^ (k+1)); % (2.3)
end

figure();
hold on;
plot(0:1:max_events, P, 'r', 'DisplayName', '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ');
plot(0:1:max_events, P_theor, 'b', 'DisplayName', '–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ');
legend();
hold off;
title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π");
